## 1. åŠ¨æœº

### **1.1 ä¼ ç»ŸRAGè¯„ä¼°çš„å±€é™æ€§**

ç°æœ‰è¯„ä¼°æŒ‡æ ‡åœ¨å¤æ‚ç”Ÿæˆåœºæ™¯ä¸‹å­˜åœ¨æ˜¾è‘—ç¼ºé™·ï¼Œéš¾ä»¥å…¨é¢é‡åŒ–RAGç³»ç»Ÿçš„çœŸå®æ€§èƒ½ï¼š

| **è¯„ä¼°æŒ‡æ ‡** | **æ ¸å¿ƒç¼ºé™·** | **å…¸å‹æ¡ˆä¾‹åˆ†æ** |
| --- | --- | --- |
| **ç­”æ¡ˆå¿ å®æ€§** | æ— æ³•æ£€æµ‹ç”Ÿæˆç­”æ¡ˆä¸­çš„**äº‹å®æ€§å¹»è§‰** | â–¶ æé—®ï¼š"çˆ±å› æ–¯å¦ç›¸å¯¹è®ºå†…å®¹"â–¶ ç”Ÿæˆç­”æ¡ˆï¼š"åŒ…å«ç‹­ä¹‰/å¹¿ä¹‰ç›¸å¯¹è®ºï¼ˆæ­£ç¡®ï¼‰+ æå‡ºé‡å­åŠ›å­¦ï¼ˆè™šæ„ï¼‰"â–¶ ä¼ ç»ŸæŒ‡æ ‡è¯„åˆ†ï¼šé«˜ï¼ˆä»…éªŒè¯å¼•ç”¨å®Œæ•´æ€§ï¼‰ |
| **ç­”æ¡ˆç›¸å…³æ€§** | ä¾èµ–å­—é¢åŒ¹é…å¯¼è‡´**ä¿¡æ¯å¯†åº¦è¯¯åˆ¤** | â–¶ ä¼˜è´¨ç­”æ¡ˆï¼š"å¥åº·é¥®é£Ÿéœ€åŒ…å«æ°´æœã€è”¬èœç­‰5ç±»é£Ÿç‰©"â–¶ ä½è´¨ç­”æ¡ˆï¼š"å¥åº·é¥®é£Ÿå¾ˆé‡è¦"â–¶ ä¼ ç»ŸæŒ‡æ ‡è¯„åˆ†ï¼šä¸¤è€…ç›¸å…³æ€§ç­‰åŒ |

### **1.2** æˆ‘ä»¬çš„æ–¹æ³•

**LLM as Judge**ï¼šåˆ©ç”¨æ€ç»´é“¾ä¸€æ­¥æ­¥æ¨å¯¼å¾—å‡ºanswerçš„æœ€ç»ˆæ­£ç¡®æ€§ï¼Œä½†æˆæœ¬æ˜‚è´µï¼Œé€šè¿‡å°æ¨¡å‹å¯¹é½å¤§æ¨¡å‹çš„æ¨ç†é€»è¾‘ï¼Œå®ç°ä½æˆæœ¬é«˜ç²¾åº¦çš„è¯„ä¼°èƒ½åŠ›è¿ç§»ã€‚

## 2. å¦‚ä½•è¯„æµ‹æ•ˆæœ

**æ•°æ®é›†æ¥æºï¼š**[FlashRAGæ•°æ®é›† Â· æ•°æ®é›†](https://www.modelscope.cn/datasets/hhjinjiajie/FlashRAG_Dataset)ä¸­çš„wiki_qaå…¶ä¸­æœ‰answerçš„æ•°æ®`ï¼ˆ861æ¡æ ·æœ¬ï¼Œè®­ç»ƒ/éªŒè¯=761/100ï¼‰`

**æ„å»ºæ•°æ®é›†ï¼š**

1. queryè¾“å…¥è±†åŒ…-1.5-lite-32kï¼Œå¾—åˆ°ä¸€ä¸ªanswer-hat
2. answerå’Œanswer_hatè¾“å…¥deepseek-r1ï¼Œè¯„ä¼°answer-hatç­”æ¡ˆæ­£ç¡®æ€§ï¼Œå¾—åˆ°ä¸€ä¸ªæ€ç»´é“¾thinkå’Œè¯„ä¼°ç»“æœoutput
3. å¾—åˆ°æ¨¡å‹è¾“å…¥ï¼šanswerå’Œanswer_hatï¼Œæ¨ç†è¿‡ç¨‹ï¼šthinkï¼Œç»“æœï¼šoutputã€‚

|  | ä¸»è¦ç­”æ¡ˆæ­£ç¡®æ€§ | æ¬¡è¦ç­”æ¡ˆæ­£ç¡®æ€§ | æ ¼å¼æ­£ç¡®æ€§ |
| --- | --- | --- | --- |
| **Qwen2.5-1.5B-Instruct** | 64 | 76 | 100 |
| **SFT-Lora-cot** | 63 | 69 | 95 |
| **RL-GRPO-16** | 75 | 76 | 100 |
| **RL-GRPO-32** | 75 | 78 | 100 |
- RL-GRPOç³»åˆ—æ¨¡å‹è¾ƒåŸºçº¿æå‡**11%**ï¼Œå¼ºåŒ–å­¦ä¹ åœ¨å…³é”®äº‹å®éªŒè¯ä¸Šçš„æ˜¾è‘—ä¼˜åŠ¿ã€‚
- SFT-LoRA-CoTè¡¨ç°ç•¥ä½äºåŸºçº¿ï¼ˆ-1%ï¼‰ï¼Œå•çº¯ç›‘ç£å­¦ä¹ æ¨¡å‹èƒ½åŠ›æœ‰ä¸Šé™ã€‚

## 3. é—®é¢˜æ–¹æ³•

### 3.1 é—®é¢˜

å°æ¨¡å‹æ¨ç†èƒ½åŠ›ä¸è¶³ï¼Œå¯è§£é‡Šæ€§å·®

### 3.2 è§£å†³æ–¹æ³•

- ğŸš€ **æ€ç»´é“¾ï¼ˆChain-of-Thoughtï¼‰å¢å¼ºè¯„ä¼°ï¼š**é€šè¿‡å°æ¨¡å‹ç”Ÿæˆå¯è§£é‡Šçš„è¯„åˆ†æ¨ç†è¿‡ç¨‹
- ğŸ”„ **ä¸¤é˜¶æ®µè®­ç»ƒæ¡†æ¶**ï¼š
  1. **ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰**ï¼šå­¦ä¹ åŸºç¡€æ¨ç†æ ¼å¼
  2. **å¼ºåŒ–å­¦ä¹ ï¼ˆRLï¼‰**ï¼šæå‡å¤æ‚åœºæ™¯æ³›åŒ–èƒ½åŠ›

### 3.3 åŸå› â€”â€”>ä¸ºä»€ä¹ˆè¦ç”¨å¼ºåŒ–å­¦ä¹ 

- **ç›‘ç£å­¦ä¹ ç¼ºç‚¹**ï¼šæ¨¡å‹åªèƒ½è¢«åŠ¨æ¨¡ä»¿æ ‡æ³¨çš„æ¨ç†è·¯å¾„ï¼Œç¼ºä¹è‡ªä¸»æ¢ç´¢èƒ½åŠ›ã€‚å¯¹äºå¤æ‚é—®é¢˜ï¼ˆå¦‚å¤šæ­¥æ¨ç†ã€æ¨¡ç³Šè¾¹ç•Œçš„è¯„åˆ†ï¼‰ï¼Œæ¨¡å‹å¯èƒ½ä»…å­¦ä¼š"è¡¨é¢æ ¼å¼"ï¼Œä½†æ— æ³•çœŸæ­£ä¼˜åŒ–æ¨ç†è´¨é‡ã€‚
- **RLçš„ä¼˜åŠ¿**ï¼šé€šè¿‡è®¾è®¡**ç»†ç²’åº¦å¥–åŠ±å‡½æ•°**ï¼ˆå¦‚è¯„åˆ†æ ¼å¼æ­£ç¡®æ€§ã€å…³é”®äº‹å®åŒ¹é…åº¦ï¼‰ï¼ŒRLå…è®¸æ¨¡å‹åœ¨è‡ªç”±ç”Ÿæˆè¿‡ç¨‹ä¸­åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œé€æ­¥é€¼è¿‘æœ€ä¼˜æ¨ç†è·¯å¾„ï¼Œè€Œéæœºæ¢°å¤åˆ¶æ ‡æ³¨æ•°æ®ã€‚
- **RLçš„æ³›åŒ–æœºåˆ¶ï¼š**é€šè¿‡è®©æ¨¡å‹åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æ¢ç´¢å¤šç§å¯èƒ½çš„æ¨ç†è·¯å¾„ï¼ˆå¦‚å°è¯•ä¸åŒçš„äº‹å®å¯¹æ¯”ç­–ç•¥ï¼‰ã€‚

## 4. SFT

### 4.1 æ•°æ®æ„é€ 

è¾“å…¥ï¼šanswerï¼Œanswer_hatè®©æ¨¡å‹è¯„ä¼°

è¾“å‡ºï¼š<think>â€”â€”<think>+<output>â€”â€”<output>

### 4.2 è®­ç»ƒå‚æ•°

```python
r = 16
lora_alpha = 16,#LoRA çš„ç¼©æ”¾å› å­ LoRA çš„æ›´æ–°é‡ä¸º ä½ç§©çŸ©é˜µ A * ä½ç§©çŸ©é˜µ B * (alpha / r)ã€‚
lora_dropout = 0,
per_device_train_batch_size = 2,# æ¯ä¸ªè®¾å¤‡ï¼ˆå¦‚ GPUï¼‰ä¸Šçš„è®­ç»ƒæ‰¹æ¬¡å¤§å°ã€‚
gradient_accumulation_steps = 4,# å¤šæ¬¡ç´¯ç§¯æ¢¯åº¦å†æ›´æ–°å‚æ•°ï¼Œæ¨¡æ‹Ÿæ›´å¤§çš„æ‰¹æ¬¡å¤§å°ã€‚
warmup_steps = 5,# åœ¨è®­ç»ƒåˆæœŸé€æ­¥å°†å­¦ä¹ ç‡ä» 0 å¢åŠ åˆ°è®¾å®šå€¼ï¼Œé¿å…åˆå§‹é˜¶æ®µå‚æ•°æ›´æ–°è¿‡å¤§ã€‚
max_steps = 60,# æœ€å¤§è®­ç»ƒæ­¥æ•°ã€‚
learning_rate = 2e-4,
fp16 = not is_bfloat16_supported()#æ˜¯å¦å¯ç”¨ FP16 æ··åˆç²¾åº¦è®­ç»ƒã€‚
weight_decay = 0.01
```

### 4.3 è®­ç»ƒç»“æœ

- æŸå¤±å€¼ä»åˆå§‹çš„çº¦2.25å¿«é€Ÿä¸‹é™è‡³0.75å·¦å³ï¼ˆ60æ­¥å†…ï¼‰ï¼Œæ•´ä½“ä¸‹é™è¶‹åŠ¿æ˜æ˜¾ã€‚
- ä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œåœ¨è®­ç»ƒ60stepåœ¨æ¨¡å‹æœ‰æ€ç»´é“¾ä¹‹åå°±åœæ‰äº†SFT

![image.png](attachment:1725f37d-ea6b-43e6-a441-597790422425:image.png)

## 5. GRPO

### 5.1 æ•°æ®å’Œå¥–åŠ±å‡½æ•°

æ•°æ®ä½¿ç”¨ï¼šè¾“å…¥ï¼šanswerï¼Œanswer_hatè®©æ¨¡å‹è¯„ä¼°ï¼Œåªä½¿ç”¨outputç»™æ¨¡å‹å¥–åŠ±(ç»“æœæ­£ç¡®)

å¥–åŠ±å‡½æ•°ï¼šæ ¼å¼å¥–åŠ±å’Œç»“æœæ­£ç¡®çš„å¥–åŠ±ï¼ˆåŸºäºè§„åˆ™ï¼‰

### 5.2 è®­ç»ƒå‚æ•°

```python
    use_vllm = True, # use vLLM for fast inference
    vllm_gpu_memory_utilization = 0.9,
    learning_rate = 3e-5,
    adam_beta1 = 0.9,#æ§åˆ¶ Adam ä¼˜åŒ–å™¨çš„ä¸€é˜¶ï¼ˆåŠ¨é‡ï¼‰å’ŒäºŒé˜¶ï¼ˆè‡ªé€‚åº”å­¦ä¹ ç‡ï¼‰ä¼°è®¡è¡°å‡ç‡ã€‚
    adam_beta2 = 0.999,
    weight_decay = 0.1,
    warmup_ratio = 0.1,#é¢„çƒ­æ­¥æ•°
    beta=0.01,#klæ•£åº¦çš„ç³»æ•°ï¼Œè¶Šå°æ¨¡å‹æ›´è‡ªç”±
    per_device_train_batch_size = 16,#å• GPU æ¯æ¬¡å¤„ç†çš„æ ·æœ¬æ•°
    gradient_accumulation_steps = 8, # Increase to 4 for smoother training
    num_generations = 16, # æ¯è½®è¯„ä¼°ç”Ÿæˆçš„æ–‡æœ¬æ•°é‡ï¼Œå½±å“éªŒè¯é˜¶æ®µå†…å­˜å ç”¨
    max_prompt_length = max_seq_length,
    max_completion_length = max_seq_length//2,
    num_train_epochs = 3,
    max_grad_norm = 0.5,#æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸ã€‚
    torch_compile=True#å¯ç”¨ PyTorch 2.0 çš„å›¾ç¼–è¯‘ä¼˜åŒ–
```

### 5.3 è®­ç»ƒè¿‡ç¨‹

1. num_generations =**16**

![image.png](attachment:c6074b04-2090-49b9-b265-259670a2215b:image.png)

![image.png](attachment:d3a1e90a-86aa-443c-9e4f-f285698b4c59:image.png)

1. num_generations =32

![image.png](attachment:7f75810a-4a7e-422e-a1a1-0c3c3dcc7e1b:image.png)

![image.png](attachment:459d29c3-7f28-4ea5-849e-7907eef7b71b:image.png)
